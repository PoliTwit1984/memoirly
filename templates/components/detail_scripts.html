{% macro render_scripts(member_id) %}
<script>
let questionToDelete = null;
let draggedItem = null;
let memberId = {{ member_id }};

// Drag and Drop Handlers
document.querySelectorAll('.question-card').forEach(card => {
    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragend', handleDragEnd);
    card.addEventListener('dragover', handleDragOver);
    card.addEventListener('drop', handleDrop);
});

function handleDragStart(e) {
    draggedItem = this;
    this.classList.add('dragging');
    
    // Set the dragged item's data
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', this.dataset.id);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.question-card').forEach(card => {
        card.classList.remove('drag-over');
    });
}

function handleDragOver(e) {
    if (e.preventDefault) {
        e.preventDefault();
    }
    
    if (this !== draggedItem) {
        this.classList.add('drag-over');
    }
    
    return false;
}

function handleDrop(e) {
    e.stopPropagation();
    
    if (this === draggedItem) return;
    
    this.classList.remove('drag-over');
    
    const container = document.getElementById('questionsContainer');
    const cards = [...container.getElementsByClassName('question-card')];
    const draggedPos = cards.indexOf(draggedItem);
    const droppedPos = cards.indexOf(this);
    
    if (draggedPos < droppedPos) {
        this.parentNode.insertBefore(draggedItem, this.nextSibling);
    } else {
        this.parentNode.insertBefore(draggedItem, this);
    }
    
    // Update positions in database
    const newOrder = [...container.getElementsByClassName('question-card')].map(card => 
        parseInt(card.dataset.id)
    );
    
    updateQuestionOrder(newOrder);
    
    return false;
}

function updateQuestionOrder(questionOrder) {
    fetch(`/api/reorder_questions/${memberId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ questionOrder })
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Failed to update question order');
        }
    })
    .catch(error => {
        console.error('Error updating question order:', error);
    });
}

function generateLink(memberId) {
    fetch(`/api/generate_link/${memberId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('shareLink').value = data.link;
            document.getElementById('shareModal').style.display = 'block';
        });
}

function generateMoreQuestions(memberId) {
    const button = document.getElementById('generateBtn');
    const originalText = button.textContent;
    button.textContent = 'Generating...';
    button.disabled = true;

    fetch(`/api/generate_more_questions/${memberId}`)
        .then(response => response.json())
        .then(data => {
            const questionsSection = document.querySelector('.questions-section');
            
            // Update stats
            const totalQuestionsElement = document.getElementById('totalQuestions');
            const currentTotal = parseInt(totalQuestionsElement.textContent);
            totalQuestionsElement.textContent = currentTotal + data.questions.length;
            
            // Add new questions
            data.questions.forEach(question => {
                const questionCard = document.createElement('div');
                questionCard.className = 'question-card new';
                questionCard.id = `question-${question.id}`;
                questionCard.draggable = true;
                questionCard.dataset.id = question.id;
                questionCard.dataset.position = question.position;
                questionCard.innerHTML = `
                    <div class="question-content">
                        <div class="question-header">
                            <div class="drag-handle">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="9" cy="6" r="2"/>
                                    <circle cx="9" cy="12" r="2"/>
                                    <circle cx="9" cy="18" r="2"/>
                                    <circle cx="15" cy="6" r="2"/>
                                    <circle cx="15" cy="12" r="2"/>
                                    <circle cx="15" cy="18" r="2"/>
                                </svg>
                            </div>
                            <h3 class="question-text">${question.content}</h3>
                            <button onclick="handleDelete(event, ${question.id})" class="btn-delete" title="Delete question">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                                </svg>
                            </button>
                        </div>
                        <div class="pending-answer">
                            <p>Waiting for response...</p>
                        </div>
                    </div>
                `;
                questionsSection.appendChild(questionCard);
                
                // Add drag and drop handlers to new question
                questionCard.addEventListener('dragstart', handleDragStart);
                questionCard.addEventListener('dragend', handleDragEnd);
                questionCard.addEventListener('dragover', handleDragOver);
                questionCard.addEventListener('drop', handleDrop);
            });
            
            button.textContent = 'Questions Generated!';
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 2000);
        })
        .catch(error => {
            button.textContent = 'Error';
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 2000);
        });
}

function handleDelete(event, questionId) {
    event.preventDefault();
    event.stopPropagation();
    questionToDelete = questionId;
    document.getElementById('confirmModal').style.display = 'block';
}

function confirmDelete() {
    if (!questionToDelete) return;
    
    const questionCard = document.getElementById(`question-${questionToDelete}`);
    questionCard.classList.add('deleting');
    
    fetch(`/api/delete_question/${questionToDelete}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update total questions count
            const totalQuestionsElement = document.getElementById('totalQuestions');
            const currentTotal = parseInt(totalQuestionsElement.textContent);
            totalQuestionsElement.textContent = currentTotal - 1;
            
            // Remove question card with animation
            questionCard.classList.add('removing');
            setTimeout(() => {
                questionCard.remove();
            }, 300);
        } else {
            questionCard.classList.remove('deleting');
            alert('Could not delete question: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        questionCard.classList.remove('deleting');
        alert('Error deleting question');
    })
    .finally(() => {
        closeConfirmModal();
    });
}

function closeConfirmModal() {
    document.getElementById('confirmModal').style.display = 'none';
    questionToDelete = null;
}

function copyLink() {
    const linkInput = document.getElementById('shareLink');
    linkInput.select();
    document.execCommand('copy');
    
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Copied!';
    setTimeout(() => {
        button.textContent = originalText;
    }, 2000);
}

function sendEmail() {
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Sending...';
    button.disabled = true;
    
    fetch(`/api/send_email/${memberId}`)
        .then(response => response.json())
        .then(data => {
            button.textContent = 'Sent!';
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 2000);
        })
        .catch(error => {
            button.textContent = 'Error';
            setTimeout(() => {
                button.textContent = originalText;
                button.disabled = false;
            }, 2000);
        });
}

// Modal controls
document.querySelector('.close').onclick = function() {
    document.getElementById('shareModal').style.display = 'none';
}

window.onclick = function(event) {
    const shareModal = document.getElementById('shareModal');
    const confirmModal = document.getElementById('confirmModal');
    if (event.target == shareModal) {
        shareModal.style.display = 'none';
    }
    if (event.target == confirmModal) {
        closeConfirmModal();
    }
}
</script>
{% endmacro %}
